From 448fbaa131521e6060f9d87c83098c8cb90696ea Mon Sep 17 00:00:00 2001
From: Derek Higgins <derekh@redhat.com>
Date: Fri, 19 Jul 2013 13:55:41 +0100
Subject: [PATCH] Save images in a toci cache file or use if present

FOR DEV ONLY
If you want to
o skip building images in place of a cached version,
o mv first-boot scripts instead of rm

place this file in patches.
---
 bin/disk-image-create        | 8 ++++++++
 elements/base/dib-first-boot | 2 +-
 2 files changed, 9 insertions(+), 1 deletion(-)

diff --git a/bin/disk-image-create b/bin/disk-image-create
index efbcf85..e7fc46f 100755
--- a/bin/disk-image-create
+++ b/bin/disk-image-create
@@ -97,6 +97,13 @@ arg_to_elements "$@"
 
 IMAGE_NAME=${IMAGE_NAME%%\.${IMAGE_TYPE}}
 
+CACHEFILE=$TOCI_WORKING_DIR/image_cache/$(basename $IMAGE_NAME.$IMAGE_TYPE)
+if [ -e $CACHEFILE ] ; then
+    echo Using $CACHEFILE
+    cp $CACHEFILE $IMAGE_NAME.$IMAGE_TYPE
+    exit 0
+fi
+
 mk_build_dir
 create_base
 run_d extra-data
@@ -144,6 +151,7 @@ unmount_image
 if [ "$IS_RAMDISK" == "0" ]; then
   compress_image
   save_image $IMAGE_NAME.$IMAGE_TYPE
+  cp $IMAGE_NAME.$IMAGE_TYPE $TOCI_WORKING_DIR/image_cache/$(basename $IMAGE_NAME.$IMAGE_TYPE)
 else
   remove_image
 fi
diff --git a/elements/base/dib-first-boot b/elements/base/dib-first-boot
index 1e39860..c13a930 100755
--- a/elements/base/dib-first-boot
+++ b/elements/base/dib-first-boot
@@ -6,6 +6,6 @@ touch /var/log/first-boot.d.log
 chmod 0600 /var/log/first-boot.d.log
 
 /usr/local/bin/dib-run-parts /etc/first-boot.d >> /var/log/first-boot.d.log 2>&1
-rm -fr /etc/first-boot.d
+mv /etc/first-boot.d /etc/first-boot.d_
 # delete itself
 rm $0
-- 
1.8.1.4

